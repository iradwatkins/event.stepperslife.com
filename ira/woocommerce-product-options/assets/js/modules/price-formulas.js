"use strict";(globalThis.webpackChunkwoocommerce_product_options=globalThis.webpackChunkwoocommerce_product_options||[]).push([[982],{3412:(t,e,r)=>{r.r(e),r.d(e,{evaluateFormula:()=>$,processFormulaVariable:()=>F});var o=r(5968),i=r(324);function a(t){var e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return e.setUTCFullYear(t.getFullYear()),t.getTime()-e.getTime()}var n=r(1127),s=r(551);function l(t,e){(0,s.A)(2,arguments);var r=(0,n.A)(t),o=(0,n.A)(e),i=r.getTime()-a(r),l=o.getTime()-a(o);return Math.round((i-l)/864e5)}var u=r(7723),h=Object.defineProperty,c=(t,e,r)=>(((t,e,r)=>{e in t?h(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r})(t,"symbol"!=typeof e?e+"":e,r),r);const p={PI:Math.PI,E:Math.E,LN2:Math.LN2,LN10:Math.LN10,LOG2E:Math.LOG2E,LOG10E:Math.LOG10E,SQRT1_2:Math.SQRT1_2,SQRT2:Math.SQRT2};class f{static throwIfNotNumber(t){if("string"==typeof t)throw new Error("Strings are not allowed in math operations")}}class m{static throwIfNotNumber(t){if("string"==typeof t)throw new Error("Strings are not allowed in math operations")}}class w{static createOperatorExpression(t,e,r){if("^"===t)return new _(e,r);if(["*","/"].includes(t))return new b(t,e,r);if(["+","-"].includes(t))return new v(t,e,r);if(["<",">","<=",">=","=","!="].includes(t))return new E(t,e,r);throw new Error(`Unknown operator: ${t}`)}evaluate(t={}){throw new Error("Empty Expression - Must be defined in child classes")}toString(){return""}}class d extends w{constructor(t){if(super(),c(this,"innerExpression"),this.innerExpression=t,!(this.innerExpression instanceof w))throw new Error("No inner expression given for bracket expression")}evaluate(t={}){return this.innerExpression.evaluate(t)}toString(){return`(${this.innerExpression.toString()})`}}class g extends w{constructor(t,e="number"){switch(super(),c(this,"value"),c(this,"type"),this.value=Number(t),e){case"number":if(this.value=Number(t),isNaN(this.value))throw new Error("Cannot parse number: "+t);break;case"string":this.value=String(t);break;default:throw new Error("Invalid value type: "+e)}this.type=e}evaluate(){return this.value}toString(){switch(this.type){case"number":return String(this.value);case"string":return'"'+this.value+'"';default:throw new Error("Invalid type")}}}class v extends w{constructor(t,e,r){if(super(),c(this,"operator"),c(this,"left"),c(this,"right"),!["+","-"].includes(t))throw new Error(`Operator not allowed in Plus/Minus expression: ${t}`);this.operator=t,this.left=e,this.right=r}evaluate(t={}){const e=this.left.evaluate(t),r=this.right.evaluate(t);if(f.throwIfNotNumber(e),f.throwIfNotNumber(r),"+"===this.operator)return Number(e)+Number(r);if("-"===this.operator)return Number(e)-Number(r);throw new Error("Unknown operator for PlusMinus expression")}toString(){return`${this.left.toString()} ${this.operator} ${this.right.toString()}`}}class b extends w{constructor(t,e,r){if(super(),c(this,"operator"),c(this,"left"),c(this,"right"),!["*","/"].includes(t))throw new Error(`Operator not allowed in Multiply/Division expression: ${t}`);this.operator=t,this.left=e,this.right=r}evaluate(t={}){const e=this.left.evaluate(t),r=this.right.evaluate(t);if(f.throwIfNotNumber(e),f.throwIfNotNumber(r),"*"===this.operator)return Number(e)*Number(r);if("/"===this.operator)return Number(e)/Number(r);throw new Error("Unknown operator for MultDiv expression")}toString(){return`${this.left.toString()} ${this.operator} ${this.right.toString()}`}}class _ extends w{constructor(t,e){super(),c(this,"base"),c(this,"exponent"),this.base=t,this.exponent=e}evaluate(t={}){const e=this.base.evaluate(t),r=this.exponent.evaluate(t);return f.throwIfNotNumber(e),f.throwIfNotNumber(r),Math.pow(Number(e),Number(r))}toString(){return`${this.base.toString()}^${this.exponent.toString()}`}}class E extends w{constructor(t,e,r){if(super(),c(this,"operator"),c(this,"left"),c(this,"right"),!["<",">","<=",">=","=","!="].includes(t))throw new Error(`Operator not allowed in Logical expression: ${t}`);this.operator=t,this.left=e,this.right=r}evaluate(t={}){const e=this.left.evaluate(t),r=this.right.evaluate(t);switch(this.operator){case"<":return e<r?1:0;case">":return e>r?1:0;case"<=":return e<=r?1:0;case">=":return e>=r?1:0;case"=":return e===r?1:0;case"!=":return e!==r?1:0}throw new Error("Unknown operator for Logical expression")}toString(){return`${this.left.toString()} ${this.operator} ${this.right.toString()}`}}class y extends w{constructor(t,e,r=null){super(),c(this,"fn"),c(this,"varPath"),c(this,"argumentExpressions"),c(this,"formulaObject"),c(this,"blacklisted"),this.fn=null!=t?t:"",this.varPath=this.fn.split("."),this.argumentExpressions=e||[],this.formulaObject=r,this.blacklisted=void 0}evaluate(t={}){var e;t=t||{};const r=this.argumentExpressions.map(e=>e.evaluate(t));try{let e=x(t,this.varPath,this.fn);if(e instanceof Function)return e.apply(this,r)}catch(t){}let o;try{o=x(null!=(e=this.formulaObject)?e:{},this.varPath,this.fn)}catch(t){}if(this.formulaObject&&o instanceof Function){if(this.isBlacklisted())throw new Error("Blacklisted function called: "+this.fn);return o.apply(this.formulaObject,r)}try{const t=x(Math,this.varPath,this.fn);if(t instanceof Function)return r.forEach(t=>{m.throwIfNotNumber(t)}),t.apply(this,r)}catch(t){}throw new Error("Function not found: "+this.fn)}toString(){return`${this.fn}(${this.argumentExpressions.map(t=>t.toString()).join(", ")})`}isBlacklisted(){return void 0===this.blacklisted&&(this.blacklisted=k.functionBlacklist.includes(this.formulaObject?this.formulaObject[this.fn]:null)),this.blacklisted}}function x(t,e,r){let o=t;for(let t of e){if("object"!=typeof o)throw new Error(`Cannot evaluate ${t}, property not found (from path ${r})`);if(void 0===o[t])throw new Error(`Cannot evaluate ${t}, property not found (from path ${r})`);o=o[t]}if("object"==typeof o)throw new Error("Invalid value");return o}class S extends w{constructor(t,e=null){super(),c(this,"fullPath"),c(this,"varPath"),c(this,"formulaObject"),this.formulaObject=e,this.fullPath=t,this.varPath=t.split(".")}evaluate(t={}){var e;let r;try{r=x(t,this.varPath,this.fullPath)}catch(t){}if(void 0===r&&(r=x(null!=(e=this.formulaObject)?e:{},this.varPath,this.fullPath)),"function"==typeof r||"object"==typeof r)throw new Error(`Cannot use ${this.fullPath} as value: It contains a non-numerical value.`);return r}toString(){return`${this.varPath.join(".")}`}}const N=class t{constructor(t,e={}){c(this,"formulaExpression"),c(this,"options"),c(this,"formulaStr"),c(this,"_variables"),c(this,"_memory"),this.formulaExpression=null,this.options={memoization:!1,...e},this.formulaStr="",this._variables=[],this._memory={},this.setFormula(t)}setFormula(t){return t&&(this.formulaExpression=null,this._variables=[],this._memory={},this.formulaStr=t,this.formulaExpression=this.parse(t)),this}enableMemoization(){this.options.memoization=!0}disableMemoization(){this.options.memoization=!1,this._memory={}}splitFunctionParams(t){let e=0,r="";const o=[];for(let i of t.split(""))if(","===i&&0===e)o.push(r),r="";else if("("===i)e++,r+=i;else if(")"===i){if(e--,r+=i,e<0)throw new Error("ERROR: Too many closing parentheses!")}else r+=i;if(0!==e)throw new Error("ERROR: Too many opening parentheses!");return r.length>0&&o.push(r),o}cleanupInputFormula(t){const e=[];return t.split('"').forEach((t,r)=>{r%2==0&&(t=t.replace(/[\s]+/g,""),Object.keys(p).forEach(e=>{t=t.replace(new RegExp(`\\b${e}\\b`,"g"),`[${e}]`)})),e.push(t)}),e.join('"')}parse(t){return t=this.cleanupInputFormula(t),this._do_parse(t)}_do_parse(t){let e=t.length-1,r=0,o="initial",i=[],a="",n="",s=null,l=0,u="";for(;r<=e;){switch(o){case"initial":if(a=t.charAt(r),a.match(/[0-9.]/))o="within-nr",n="",r--;else if(this.isOperator(a)){if("-"===a&&(0===i.length||this.isOperatorExpr(i[i.length-1]))){o="within-nr",n="-";break}if(r===e||this.isOperatorExpr(i[i.length-1])){o="invalid";break}i.push(w.createOperatorExpression(a,new w,new w)),o="initial"}else if([">","<","=","!"].includes(a)){if(r===e){o="invalid";break}o="within-logical-operator",n=a}else"("===a?(o="within-parentheses",n="",l=0):"["===a?(o="within-named-var",n=""):a.match(/["']/)?(o="within-string",u=a,n=""):a.match(/[a-zA-Z]/)&&(r<e&&t.charAt(r+1).match(/[a-zA-Z0-9_.]/)?(n=a,o="within-func"):(i.length>0&&i[i.length-1]instanceof g&&i.push(w.createOperatorExpression("*",new w,new w)),i.push(new S(a,this)),this.registerVariable(a),o="initial",n=""));break;case"within-nr":a=t.charAt(r),a.match(/[0-9.]/)?(n+=a,r===e&&(i.push(new g(n)),o="initial")):("-"===n&&(n="-1"),i.push(new g(n)),n="",o="initial",r--);break;case"within-func":if(a=t.charAt(r),a.match(/[a-zA-Z0-9_.]/))n+=a;else{if("("!==a)throw new Error("Wrong character for function at position "+r);s=n,n="",l=0,o="within-func-parentheses"}break;case"within-named-var":if(a=t.charAt(r),"]"===a)i.push(new S(n,this)),this.registerVariable(n),n="",o="initial";else{if(!a.match(/[a-zA-Z0-9_.]/))throw new Error("Character not allowed within named variable: "+a);n+=a}break;case"within-string":a=t.charAt(r),a===u?(i.push(new g(n,"string")),n="",o="initial",u=""):n+=a;break;case"within-parentheses":case"within-func-parentheses":if(a=t.charAt(r),u)a===u&&(u=""),n+=a;else if(")"===a)if(l<=0){if("within-parentheses"===o)i.push(new d(this._do_parse(n)));else if("within-func-parentheses"===o){let t=this.splitFunctionParams(n).map(t=>this._do_parse(t));i.push(new y(s,t,this)),s=null}o="initial"}else l--,n+=a;else"("===a?(l++,n+=a):(a.match(/["']/)&&(u=a),n+=a);break;case"within-logical-operator":a=t.charAt(r),"="===a&&(n+=a,r++),i.push(w.createOperatorExpression(n,new w,new w)),n="",o="initial",r--}r++}if("initial"!==o)throw new Error("Could not parse formula: Syntax error.");return this.buildExpressionTree(i)}buildExpressionTree(t){if(t.length<1)throw new Error("No expression given!");const e=[...t];let r=0,o=null;for(;r<e.length;)if(o=e[r],o instanceof _){if(0===r||r===e.length-1)throw new Error("Wrong operator position!");o.base=e[r-1],o.exponent=e[r+1],e[r-1]=o,e.splice(r,2)}else r++;for(r=0,o=null;r<e.length;)if(o=e[r],o instanceof b){if(0===r||r===e.length-1)throw new Error("Wrong operator position!");o.left=e[r-1],o.right=e[r+1],e[r-1]=o,e.splice(r,2)}else r++;for(r=0,o=null;r<e.length;)if(o=e[r],o instanceof v){if(0===r||r===e.length-1)throw new Error("Wrong operator position!");o.left=e[r-1],o.right=e[r+1],e[r-1]=o,e.splice(r,2)}else r++;for(r=0,o=null;r<e.length;)if(o=e[r],o instanceof E){if(0===r||r===e.length-1)throw new Error("Wrong operator position!");o.left=e[r-1],o.right=e[r+1],e[r-1]=o,e.splice(r,2)}else r++;if(1!==e.length)throw new Error("Could not parse formula: incorrect syntax?");return e[0]}isOperator(t){return"string"==typeof t&&t.match(/[+\-*/^]/)}isOperatorExpr(t){return t instanceof v||t instanceof b||t instanceof _||t instanceof E}registerVariable(t){this._variables.indexOf(t)<0&&this._variables.push(t)}getVariables(){return this._variables}evaluate(t){if(t instanceof Array)return t.map(t=>this.evaluate(t));let e=this.getExpression();if(!(e instanceof w))throw new Error("No expression set: Did you init the object with a Formula?");if(this.options.memoization){let r=this.resultFromMemory(t);return null!==r||(r=e.evaluate({...p,...t}),this.storeInMemory(t,r)),r}return e.evaluate({...p,...t})}hashValues(t){return JSON.stringify(t)}resultFromMemory(t){let e=this.hashValues(t),r=this._memory[e];return void 0!==r?r:null}storeInMemory(t,e){this._memory[this.hashValues(t)]=e}getExpression(){return this.formulaExpression}getExpressionString(){return this.formulaExpression?this.formulaExpression.toString():""}static calc(e,r=null,o={}){return r=null!=r?r:{},new t(e,o).evaluate(r)}};c(N,"Expression",w),c(N,"BracketExpression",d),c(N,"PowerExpression",_),c(N,"MultDivExpression",b),c(N,"PlusMinusExpression",v),c(N,"LogicalExpression",E),c(N,"ValueExpression",g),c(N,"VariableExpression",S),c(N,"FunctionExpression",y),c(N,"MATH_CONSTANTS",p),c(N,"functionBlacklist",Object.getOwnPropertyNames(N.prototype).filter(t=>N.prototype[t]instanceof Function).map(t=>N.prototype[t]));let k=N;(0,u.__)("Price","woocommerce-product-options"),(0,u.__)("Quantity in cart","woocommerce-product-options"),(0,u.__)("Weight","woocommerce-product-options"),(0,u.__)("Width","woocommerce-product-options"),(0,u.__)("Length","woocommerce-product-options"),(0,u.__)("Height","woocommerce-product-options"),(0,u.__)("+","woocommerce-product-options"),(0,u.__)("-","woocommerce-product-options"),(0,u.__)("*","woocommerce-product-options"),(0,u.__)("/","woocommerce-product-options"),(0,u.__)("(","woocommerce-product-options"),(0,u.__)(")","woocommerce-product-options"),(0,u.__)("<","woocommerce-product-options"),(0,u.__)(">","woocommerce-product-options"),(0,u.__)("<=","woocommerce-product-options"),(0,u.__)(">=","woocommerce-product-options"),(0,u.__)("=","woocommerce-product-options"),(0,u.__)("!=","woocommerce-product-options");var A=r(5104);const F=(t,e)=>{var r,a,n,s,u;t.var=t.var||t.name;const h=t.var.split(".")[0].toLowerCase(),c=e.querySelector(`.wpo-field[data-option-id="${t.id}"]`),p=c?.classList.contains("wpo-field-hide"),f=(0,o.P4)(e),m=t=>p?0:null!=t?t:0,w=t.type.replace("_option","");let d=(0,i.xL)(w);switch("select"===d&&(d="option"),t.type){case"number_option":case"customer_price_option":const t=c?.querySelector("input");return{[h]:parseFloat(null!==(r=t?.value)&&void 0!==r?r:0)};case"file_upload_option":const e=c?.querySelector("input"),o=JSON.parse(e.value);return{[h]:{count:m(null!==(a=o?.length)&&void 0!==a?a:0)}};case"checkbox_option":case"radio_option":case"dropdown_option":case"images_option":case"color_swatches_option":case"text_labels_option":const p=`${d}:checked`,g=c?.querySelectorAll(d),v=Array.from(c?.querySelectorAll(p))?.filter(t=>t.value),b=null!==(n=v?.length)&&void 0!==n?n:0,_=Array.from(v)?.filter(t=>t?.dataset?.formulaValue),E=Array.from(_).reduce((t,e)=>Math.max(t,parseFloat(e.dataset.formulaValue)),_.length>0?-1/0:0),y=Array.from(_).reduce((t,e)=>Math.min(t,parseFloat(e.dataset.formulaValue)),_.length>0?1/0:0),x=Array.from(_).reduce((t,e)=>t+parseFloat(e.dataset.formulaValue),0),S=0===b,N=b>0,k=b===g.length,A={choices:{}};return g.forEach((t,e)=>{if(!t.value)return;e=t.dataset?.index||e;const r="option"===d?t.selected:t.checked;A.choices[`choice${e}`]={checked:r?m(1):0,value:r?m(parseFloat(t.dataset?.formulaValue||0)):0}}),{[h]:{...A,none:S?m(1):0,any:N?m(1):0,all:k?m(1):0,count:m(b),min:m(y),max:m(E),sum:m(x),selected:N?m(1):0,value:m(parseFloat(c.querySelector(p)?.dataset?.formulaValue||0))}};case"text_option":case"textarea_option":const F=c?.querySelector?.("text"===w?"input":"textarea"),$=null!==(s=F?.value?.trim?.())&&void 0!==s?s:"",O={characters:m($.replace(/[\n\r ]/gi," ").replace(/ +/gi," ").trim().length),words:m($.replace(/[\n\r ]/gi," ").replace(/ +/gi," ").trim().split(" ").filter(Boolean).length)};return"textarea"===w&&(O.lines=m($.split("\n").filter(Boolean).length)),{[h]:O};case"price_formula_option":return{[h]:m(parseFloat(c.dataset.optionPrice))};case"datepicker_option":const M=c?.querySelector("input"),L={daycount:m(l(new Date(M?.value),new Date)),weekday:m((7+new Date(M?.value).getDay()-wpoSettings.start_of_week)%7+1),day:m(new Date(M?.value).getDate()),month:m(new Date(M?.value).getMonth()+1),year:m(new Date(M?.value).getFullYear())};return{[h]:L};case"product_option":d=(0,i.xL)(c?.dataset?.type),"select"===d&&(d="option");const P=`${d}:checked`,C=Array.from(c?.querySelectorAll(d))?.filter(t=>t.value),I=Array.from(c?.querySelectorAll(P))?.filter(t=>t.value),V=null!==(u=I?.length)&&void 0!==u?u:0,j={none:0===V?m(1):0,any:V>0?m(1):0,all:V===C.length?m(1):0,count:m(V),min:m(Array.from(I).reduce((t,e)=>Math.min(t,parseFloat(e.dataset.priceAmount)),V>0?1/0:0)),max:m(Array.from(I).reduce((t,e)=>Math.max(t,parseFloat(e.dataset.priceAmount)),0)),total:m(Array.from(I).reduce((t,e)=>t+parseFloat(e.dataset.priceAmount),0)),selected:V>0?m(1):0,price:m(Array.from(I).reduce((t,e)=>t+parseFloat(e.dataset.priceAmount),0))};return{[h]:j};case"product":switch(h){case"product_price":return{product_price:parseFloat(f.price||0)};case"product_quantity":return{product_quantity:parseInt(f.quantity||0)};case"product_weight":return{product_weight:parseFloat(f.weight||0)};case"product_width":return{product_width:parseFloat(f.width||0)};case"product_length":return{product_length:parseFloat(f.length||0)};case"product_height":return{product_height:parseFloat(f.height||0)};default:return{}}default:return{}}},$=t=>{if(t.element.classList.contains("wpo-field-hide"))return;const e=t.element.closest("form");let r;t.formula=t.formula?.toLowerCase(),(t=>t.map((e,r)=>{for(let o=r-1;o>=0;o--){const r=new RegExp(`\\[${t[o].name}\\]`,"gi");e={...e,formula:e.formula.replace(r,`(${t[o].formula})`)}}return e}))(t.customFormulaVariables||[]).forEach(e=>{t.formula=t.formula.replaceAll(`[${e.name?.toLowerCase()}]`,`(${e.formula.toLowerCase()})`)}),t.formulaVariables.forEach(e=>{e.var=e.var||e.name,t.formula=t.formula.replaceAll(`[${e.name?.toLowerCase()}]`,`[${e.var}]`)});try{r=new k(t.formula.toLowerCase())}catch(t){return}const i=r.getVariables(),a=i.filter(e=>t.formulaVariables.findIndex(t=>(t.var=t.var||t.name,t.var.split(".")[0].toLowerCase()===e.split(".")[0].toLowerCase()))>-1||t.customFormulaVariables.findIndex(t=>t.name.toLowerCase()===e.toLowerCase())>-1);if(i.filter(t=>!a.find(e=>e.split(".")[0].toLowerCase()===t.split(".")[0].toLowerCase())).length>0)return;const n=t.formulaVariables.reduce((t,r)=>({...t,...F(r,e)}),{});if((0,o.$8)())return{option_id:t.optionId,variables:n};const s={...n,...(0,A.h0)((0,A.Nh)(e)),...(0,A.h0)((0,A.pu)(e))},l=r.evaluate(s);return isNaN(l)?void 0:{field:t,id:t.optionId,type:"price_formula",amount:l}}}}]);