##
# SteppersLife Events - Nginx Site Configuration
#
# This configuration sets up a reverse proxy from Nginx to the Next.js app
# running on port 3004 via PM2.
#
# Installation:
#   1. Copy this file to: /etc/nginx/sites-available/event.stepperslife.com
#   2. Create symlink: sudo ln -s /etc/nginx/sites-available/event.stepperslife.com /etc/nginx/sites-enabled/
#   3. Test config: sudo nginx -t
#   4. Reload Nginx: sudo systemctl reload nginx
#   5. Set up SSL: sudo certbot --nginx -d event.stepperslife.com
##

# Redirect HTTP to HTTPS (after SSL setup)
server {
    listen 80;
    listen [::]:80;
    server_name event.stepperslife.com www.event.stepperslife.com;

    # Uncomment after running certbot for SSL
    # return 301 https://$server_name$request_uri;

    # Temporary location before SSL setup
    location / {
        proxy_pass http://localhost:3004;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTPS Configuration (certbot will add this automatically)
# After running certbot, it will modify this file to add SSL certificates
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name event.stepperslife.com www.event.stepperslife.com;
#
#     # SSL certificates (certbot adds these)
#     ssl_certificate /etc/letsencrypt/live/event.stepperslife.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/event.stepperslife.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     # Security headers
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
#
#     # Reverse proxy to Next.js app
#     location / {
#         proxy_pass http://localhost:3004;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_cache_bypass $http_upgrade;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#
#         # Timeouts
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 60s;
#         proxy_read_timeout 60s;
#
#         # Buffer settings
#         proxy_buffering on;
#         proxy_buffer_size 4k;
#         proxy_buffers 8 4k;
#         proxy_busy_buffers_size 8k;
#     }
#
#     # Static assets caching
#     location /_next/static {
#         proxy_pass http://localhost:3004;
#         proxy_cache_valid 200 60m;
#         add_header Cache-Control "public, max-age=3600, immutable";
#     }
#
#     # Public assets
#     location /public {
#         proxy_pass http://localhost:3004;
#         add_header Cache-Control "public, max-age=3600";
#     }
#
#     # Gzip compression
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1024;
#     gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
# }

# Redirect www to non-www (optional)
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name www.event.stepperslife.com;
#
#     ssl_certificate /etc/letsencrypt/live/event.stepperslife.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/event.stepperslife.com/privkey.pem;
#
#     return 301 https://event.stepperslife.com$request_uri;
# }
